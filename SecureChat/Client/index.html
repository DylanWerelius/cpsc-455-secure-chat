<!-- In simple terms, this is the front-end code -->
<!-- Written by Dylan Werelius & Victoria Guzman -->
<!-- Reference: https://youtu.be/TItbp7c9MNQ -->

<html lang="en">
    <head>
        <title>SecureChat</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
        <script defer src="app.js"></script>
    </head>

    <body class = "flex flex-col items-center justify-center h-screen bg-gray-100">
        <h1 class = "text-2xl font-bold mb-4">SecureChat</h1>

        <!-- register form & login form -->
        <div id="auth-section" class="p-4 bg-white shadow-md rounded-lg">
            <h2 class="text-xl font-semibold mb-2">Register / Login</h2>
            <input id="username" type="text" placeholder="Username" class="border px-3 py-2 mb-2 w-full rounded"/>
            <input id="password" type="password" placeholder="Password" class="border px-3 py-2 mb-2 w-full rounded"/>
            <button onclick="register()" class="bg-green-500 text-white px-4 py-2 rounded w-full mb-2 
                hover:bg-green-600 transition-colors focus:ring-2 focus:ring-green-300">Register</button>
            <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded w-full 
                hover:bg-blue-600 transition-colors focus:ring-2 focus:ring-blue-300">Login</button>
            <p id="auth-error" class="text-red-500 mt-2 text-sm hidden"></p>
        </div>

        <!-- Chat section(Hidden until logged in)-->
        <div id="chat-section" class="h-screen w-screen flex flex-col justify-between hidden">
            <!-- This is the section that controls who you are sending messages to -->
            <div class="p-4 border rounded w-full flex items-center space-x-2 bg-gray-100">
                <label for="recipient" class="font-semibold">Send To:</label>
                <select id="recipient" class="p-2 border rounded bg-white">
                    <option value="all">All</option>
                </select>
            </div>
            <div id="chat-box" class="p-3 overflow-auto">
                <!-- This is where the messages will go -->
            </div>
            <!-- File Upload UI -->
            <div class="p-2 bg-white border-t flex items-center space-x-4">
                <label for="fileInput" class="cursor-pointer text-blue-600 hover:underline">ğŸ“ Upload File</label>
                <input type="file" id="fileInput" class="hidden" />
            </div>
            <!-- This is the div that holds the message and send button -->
            <div class="flex">
                <!-- This is the message box -->
                <input id="message" type="text" class="px-3 w-full border-t border-gray-300 outline-none text-gray-700" 
                placeholder="Type your message..." />
                <button onclick="toggleEmojiPicker()">ğŸ˜€</button>
                <div id="emojiPicker" class="flex flex-wrap gap-2 p-2">
                    <button onclick="addEmoji('ğŸ˜€')">ğŸ˜€</button>
                    <button onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</button>
                    <button onclick="addEmoji('ğŸ˜')">ğŸ˜</button>
                    <button onclick="addEmoji('ğŸ”¥')">ğŸ”¥</button>
                    <button onclick="addEmoji('ğŸ‰')">ğŸ‰</button>
                    <button onclick="addEmoji('ğŸ‘')">ğŸ‘</button>
                  </div>                                   
                  
                <!-- This is the send button -->
                <button class="px-8 py-3 bg-green-500 text-white hover:bg-green-600 transition-colors" onclick="sendMessage()">Send</button>
            </div>
        </div>
        <script>
            let rsaKeyPair;

            (async () => {
            rsaKeyPair = await window.crypto.subtle.generateKey(
                {
                name: "RSA-OAEP",
                modulusLength: 4096,
                publicExponent: new Uint8Array([1, 0, 1]),
                hash: "SHA-256"
                },
                true,
                ["encrypt", "decrypt"]
            );
            })();

            const fileInput = document.getElementById("fileInput");
            
            fileInput.addEventListener("change", async (e) => {
              const file = e.target.files[0];
              if (!file) return;
            
              const arrayBuffer = await file.arrayBuffer();
            
              const aesKey = await crypto.subtle.generateKey(
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt"]
              );
            
              const rawKey = await crypto.subtle.exportKey("raw", aesKey);
              const iv = crypto.getRandomValues(new Uint8Array(12));
            
              const encrypted = await crypto.subtle.encrypt(
                { name: "AES-GCM", iv },
                aesKey,
                arrayBuffer
              );
            
              const payload = {
                type: "file",
                filename: file.name,
                mime: file.type,
                encrypted: btoa(String.fromCharCode(...new Uint8Array(encrypted))),
                iv: Array.from(iv),
                aesKey: Array.from(new Uint8Array(rawKey)), // Placeholder, to be encrypted via RSA later
                recipient: document.getElementById("recipient").value
              };
            
              ws.send(JSON.stringify(payload));
            });
            ws.addEventListener("message", async (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "file") {
                  const encryptedAESKey = new Uint8Array(data.aesKey);
                  const iv = new Uint8Array(data.iv);
                  const encryptedData = Uint8Array.from(atob(data.encrypted), c => c.charCodeAt(0));
              
                  const rawAESKey = await crypto.subtle.decrypt(
                    { name: "RSA-OAEP" },
                    rsaKeyPair.privateKey,
                    encryptedAESKey
                  );
              
                  const aesKey = await crypto.subtle.importKey(
                    "raw",
                    rawAESKey,
                    { name: "AES-GCM" },
                    false,
                    ["decrypt"]
                  );
              
                  const decrypted = await crypto.subtle.decrypt(
                    { name: "AES-GCM", iv },
                    aesKey,
                    encryptedData
                  );
              
                  const blob = new Blob([decrypted], { type: data.mime });
                  const link = document.createElement("a");
                  link.href = URL.createObjectURL(blob);
                  link.download = data.filename;
                  link.textContent = `ğŸ“ Download: ${data.filename}`;
                  link.classList.add("block", "text-blue-500", "hover:underline", "mt-2");
              
                  document.getElementById("chatBox").appendChild(link);
                }
              });
              </script>
            
    </body>
</html>